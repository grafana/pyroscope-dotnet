PROFILER_DIR := $(CURDIR)/../profiler/_build/DDProf-Deploy/linux
DOTNET := ~/.dotnet/dotnet

.PHONY: run
run:
	CORECLR_ENABLE_NOTIFICATION_PROFILERS=1 \
	CORECLR_NOTIFICATION_PROFILERS=$(PROFILER_DIR)/Pyroscope.Profiler.Native.so={BD1A650D-AC5D-4896-B64F-D6FA25D6B26A} \
	LD_PRELOAD=$(PROFILER_DIR)/Datadog.Linux.ApiWrapper.x64.so \
	LD_LIBRARY_PATH=$(PROFILER_DIR) \
	PYROSCOPE_PROFILING_ENABLED=1 \
	PYROSCOPE_PROFILING_ALLOCATION_ENABLED=true \
	PYROSCOPE_PROFILING_CONTENTION_ENABLED=true \
	PYROSCOPE_PROFILING_EXCEPTION_ENABLED=true \
	PYROSCOPE_PROFILING_HEAP_ENABLED=true \
	PYROSCOPE_LOG_LEVEL=debug \
	PYROSCOPE_SERVER_ADDRESS=http://localhost:4040 \
	PYROSCOPE_APPLICATION_NAME=rideshare.dotnet.app \
	ASPNETCORE_URLS=http://*:5000 \
	$(DOTNET) run --project Rideshare.csproj --framework net8.0 --no-launch-profile
